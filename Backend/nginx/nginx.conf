worker_processes auto;

events {
    worker_connections 10240;  # Allows handling of 10,000+ concurrent users
}

http {
    upstream authentication_service {
        server authentication_service:3002;
    }

    upstream transaction_service {
        server transaction_service:3003;
    }

    upstream engine_service {
        server engine_service:3004;
    }

    upstream setup_service {
        server setup_service:3005;
    }

    upstream matching_engine_service {
        server matching_engine_service:3006;
    }

    server {
        listen 3001;  # Main API Gateway Entry Point

        # âœ… Authentication Routes
        location /authentication/ {
            proxy_pass http://authentication_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # âœ… Transaction Routes (Explicitly Defined)
        location /transaction/getStockPrices {
            proxy_pass http://transaction_service;
        }

        location /transaction/getStockPortfolio {
            proxy_pass http://transaction_service;
        }

        location /transaction/getStockTransactions {
            proxy_pass http://transaction_service;
        }

        location /transaction/addMoneyToWallet {
            proxy_pass http://transaction_service;
        }

        location /transaction/getWalletBalance {
            proxy_pass http://transaction_service;
        }

        location /transaction/getWalletTransactions {
            proxy_pass http://transaction_service;
        }

        # âœ… Engine Routes
        location /engine/placeStockOrder {
            proxy_pass http://engine_service;
        }

        location /engine/cancelStockTransaction {
            proxy_pass http://engine_service;
        }

        # âœ… Setup Routes
        location /setup/createStock {
            proxy_pass http://setup_service;
        }

        location /setup/addStockToUser {
            proxy_pass http://setup_service;
        }

        location /matching-engine/processOrder {
			proxy_pass http://matching_engine_service/processOrder;
		}

		location /matching-engine/getOrderBook {
			proxy_pass http://matching_engine_service/getOrderBook;
		}


        # ðŸ”¥ Error Handling
        error_page 502 = /fallback;
        location = /fallback {
            return 502 "Service is temporarily unavailable.";
        }
    }
}
